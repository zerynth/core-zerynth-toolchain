from zdm import zdm
from wireless import wifi

# choose a wifi chip supporting secure sockets and client certificates
# from microchip.winc1500 import winc1500 as wifi_driver
from espressif.esp32net import esp32wifi as wifi_driver
import streams

# paste here your device id and password generated by the ZDM
# the password is a jwt generated from a device's key
device_id = ""
password = ""


def fota_callback():
    # This function is called after a FOTA update
    print("Fota callback called")
    return True

streams.serial()

try:
    wifi_driver.auto_init()

    for _ in range(5):
        try:
            print("connect wifi")
            # Write here your wifi SSID and password
            wifi.link("++++", wifi.WIFI_WPA2, "++++++")
            print("connect wifi done")
            break
        except Exception as e:
            print("wifi connect err", e)

    # create a ZDM Device instance with your id and the fota callback
    client = zdm.Device(device_id, fota_callback=fota_callback, endpoint="rmq.zdm.test.zerynth.com")
    # set the device's password (jwt)
    client.set_password(password)
    # connect your device to ZDM enabling the device to receive incoming messages
    client.connect()

    while True:
        sleep(1000)

except Exception as e:
    print("main", e)
